---
title: "Sandbox"
author: "Daniel P. Hall Riggins, MD"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(targets)
library(tidyverse)
library(stringr)
library(sf)
library(tidycensus)
library(lubridate)
library(gt)
tar_make()
tar_load_everything()
```


```{r}
suid |>
    select(-fips, -geometry, -suid_present)  |> 
    corrr::correlate() |>
    select(term, suid_count) |> 
    arrange(desc(abs(suid_count)))
```

```{r}
test_table <-
    suid |>
        as_tibble() |> 
        mutate(
            pop_under_five = 
                round(
                    pop_under_five / pop_total * 100, 
                    digits = 1
                )
        ) |> 
        relocate(
            pop_under_five, 
            male, 
            black, white, hispanic, spanish_language, foreign_born,
            lt_high_school, high_school_diploma, some_college, college_diploma,
            employed,
            income_lt_10, income_lt_25, income_lt_50, income_lt_75, income_gt_75,
            married_males, married_females, divorced_widowed_males, divorced_widowed_females, avg_peop_per_household,
            no_insurance, private_insurance, public_insurance, 
            svi_socioeconomic, svi_household_composition_disability, svi_minority_language, svi_housing_transportation, svi_summary_ranking
        ) |> 
        rename(
            "Black (%)" = black,
            "White (%)" = white,
            "Hispanic (%)" = hispanic,
            "Less than high school (%)" = lt_high_school,
            "High school diploma (%)" = high_school_diploma,
            "Some college (%)" = some_college,
            "College diploma (%)" = college_diploma,
            "Divorced, widowed females (%)" = divorced_widowed_females,
            "Divorced, widowed males (%)" = divorced_widowed_males,
            "Married females (%)" = married_females,
            "Married males (%)" = married_males,
            "Average number of people per household" = avg_peop_per_household,
            "Earning > national 75th percentile (%)" = income_gt_75,
            "Earning < national 10th percentile (%)" = income_lt_10,
            "Earning < national 25th percentile (%)" = income_lt_25,
            "Earning < national 50th percentile (%)" = income_lt_50,
            "Earning < national 75th percentile (%)" = income_lt_75,
            "Private insurance (%)" = private_insurance,
            "Public insurance (%)" = public_insurance,
            "No insurance (%)" = no_insurance,
            "SVI household composition & disability (national %ile)" = svi_household_composition_disability,
            "SVI socioeconomic status (national %ile)" = svi_socioeconomic,
            "SVI minority status & language (national %ile)" = svi_minority_language,
            "SVI housing type & transportation (national %ile)" = svi_housing_transportation,
            "SVI summary (national %ile)" = svi_summary_ranking,
            "Population under 5 years old (%)" = pop_under_five,
            "Opioid-related deaths (count)" = count_opioid_death,
            "Foreign-born (%)" = foreign_born,
            "Male (%)" = male,
            "Employed (%)" = employed,
            "Spanish-speaking (%)" = spanish_language
        ) |> 
        select(-fips, -suid_count, -suid_count_factor, -pop_total, -geometry) |>
        gtsummary::tbl_summary(
            by = suid_present,
            missing = "no"
        ) |>
        gtsummary::as_gt(rowname_col = "variable") |>
        cols_hide(columns = label) |> 
        cols_label(
            stat_1 = md("**No SUID**, n = 1,078"),
            stat_2 = md("**SUID Present**, n = 237"),
        ) |> 
        tab_header(
            md(
                "Comparing Cook County, IL, Census Tracts <br>
                by Presence of SUID from 2015-2019"
            )
        ) |> 
        tab_row_group(
            md("**Social Vulnerability Index**"),
            matches("^SVI")
        ) |>
        tab_row_group(
            md("**Health Insurance Status**"),
            matches("insurance")
        ) |>
        tab_row_group(md("**Household Density**"), "Average number of people per household") |> 
        tab_row_group(
            md("**Marital Status**"),
            matches("^Married|^Divorced")
        ) |>
        tab_row_group(
            md("**Income**"),
            starts_with("Earning")
        ) |>
        tab_row_group(md("**Employment**"), "Employed (%)") |> 
        tab_row_group(
            md("**Education**"), 
            c(
                "Less than high school (%)",
                "High school diploma (%)",
                "Some college (%)",
                "College diploma (%)"
            )
        ) |> 
        tab_row_group(
            md("**Culture**"), 
            c(
                "Spanish-speaking (%)",
                "Foreign-born (%)"
            )
        ) |> 
        tab_row_group(
            md("**Race/Ethnicity**"), 
            c(
                "Black (%)",
                "White (%)",
                "Hispanic (%)"
            )
        ) |> 
        tab_row_group(md("**Gender**"), "Male (%)") |> 
        tab_row_group(md("**Age**"), "Population under 5 years old (%)") |> 
        tab_style(
            style = cell_text(align = "center"),
            locations = cells_stub()
        )

test_table
```


```{r}
sids_pop_est_and_polygons |> 
    ggplot(aes(x = avg_per_household)) +
    geom_histogram()
```


```{r}
ccme_archive_suid_cases |> 
    select(auto_captured, gender, race, latino) |> 
    gtsummary::tbl_summary(by = auto_captured) |> 
    gtsummary::add_ci() |> 
    gtsummary::add_p()
```


```{r}
ccme_archive_suid_cases$latitude[ccme_archive_suid_cases$case_number == "ME2016-00123"] <- 41.77820
ccme_archive_suid_cases$longitude[ccme_archive_suid_cases$case_number == "ME2016-00123"] <- -87.61707


ccme_archive_suid_cases |> 
    filter(auto_captured == FALSE) |> 
    st_as_sf(coords = c("longitude", "latitude")) |> 
    plot()
```


```{r}
ccme_suid_per_year <-
    ccme_archive_suid_cases |> 
    group_by(year_of_death, race_ethn) |> 
    summarise(deaths = n()) |> 
    ungroup() |> 
    filter(year_of_death %in% 2015:2019) |> 
    add_row(
        year_of_death = 2016,
        race_ethn = "Other",
        deaths = 0
    ) |> 
    add_row(
        year_of_death = 2019,
        race_ethn = "Other",
        deaths = 0
    ) |> 
    add_column(
        births = c(7728, 5123, 13723, 2950, 7443, 5069, 13172, 7249, 5129, 12624, 3035, 7067, 4885, 12091, 2887, 6899, 4679, 11737, 3076, 2832)
    ) |> 
    mutate(
        deaths_per_births = deaths / births * 1E5
    )
    
```
```{r}
combined_suid <-
    ccme_suid_per_year |> 
    group_by(year_of_death) |> 
    summarise(
        births = sum(births),
        deaths = sum(deaths)
    ) |> 
    mutate(
        deaths_per_births = deaths / births * 1E5
    )
```

```{r}
combined_suid |> 
    ggplot(aes(x = as.integer(year_of_death), y = deaths_per_births)) +
    geom_line() +
    geom_point() +
    labs(
        title = "Overall Yearly Incidence of SUID cases in Cook County, IL from 2015-2021",
        x = "Year",
        y = "Deaths per 100,000 Live Births"
    ) +
    scale_x_continuous(
        breaks = 2015:2021
    ) +
    theme_linedraw()
```


```{r}
ccme_suid_per_year |> 
    ggplot(aes(x = as.integer(year_of_death), y = deaths, color = race_ethn)) +
    geom_line() +
    geom_point() +
    labs(
        title = "Counts of SUID cases in Cook County, IL from 2015-2021",
        x = "Year",
        y = "Count",
        color = "Race/Ethnicity"
    ) +
    scale_x_continuous(
        breaks = 2015:2021
    ) +
    theme_linedraw()
```

```{r}
ccme_suid_per_year |> 
    ggplot(aes(x = as.integer(year_of_death), y = births, color = race_ethn)) +
    geom_line() +
    geom_point() +
    labs(
        title = "Birth Counts in Cook County, IL from 2015-2021",
        x = "Year",
        y = "Count",
        color = "Race/Ethnicity"
    ) +
    scale_x_continuous(
        breaks = 2015:2021
    ) +
    theme_linedraw()
```

```{r}
ccme_suid_per_year |> 
    ggplot(aes(x = as.integer(year_of_death), y = deaths_per_births, color = race_ethn)) +
    geom_line() +
    geom_point() +
    labs(
        title = "Yearly Incidence of SUID cases in Cook County, IL from 2015-2021",
        x = "Year",
        y = "Deaths per 100,000 Live Births",
        color = "Race/Ethnicity"
    ) +
    scale_x_continuous(
        breaks = 2015:2021
    ) +
    theme_linedraw()
```


```{r}
filter(!is.na(longitude) & !is.na(latitude)) |> 
    st_as_sf(
        coords = c("longitude", "latitude"),
        crs = 4326
    ) |> 
    plot()
```

```{r}
library(SpatialEpi)
data(scotland)

```

