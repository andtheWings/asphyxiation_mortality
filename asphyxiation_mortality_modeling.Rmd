---
title: "Infant Asphyxiation Mortality Modeling"
author: "Daniel P. Riggins, MD"
date: "11/1/2021"
output: html_document
---

This modeling analysis will seek to predict infant asphyxiation deaths in Chicagoland census tracts using a variety of census-level predictor variables, many of which are derived from the CDC's [Social Vulnerability Index (SVI)](https://seandavi.github.io/sars2pack/reference/cdc_social_vulnerability_index.html).

# Set Up

## Load needed libraries:

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(DataExplorer)
library(corrr)
library(vcd)
library(tidycensus)
library(sf)
tidymodels_prefer()
```

## Import the data:

```{r}
raw <- readxl::read_xlsx("data/finaldataforanalysis3_110221.xlsx")

glimpse(raw)
```

# Get census tract populations and spatial features

```{r}
enriched <-
    get_acs(
        geography = "tract",
        variables = "B01003_001",
        state = "IL",
        geometry = TRUE
    ) %>%
    filter(GEOID %in% raw$FIPS) %>%
    mutate(
        FIPS = as.numeric(GEOID),
        centroid = st_centroid(geometry)
    ) %>%
    select(
        FIPS,
        population = estimate,
        centroid
    ) %>%
    full_join(raw)
```

# First Pass Exploration

## Split data into training and test sets:

```{r}
set.seed(324)
split <- initial_split(enriched, prop = 0.75)
training <- training(split)
testing <- testing(split)
```


## Summarize the primary outcome

```{r}
table(training$Count_Asphyxia)
```
## Visualize the primary outcome:

```{r}
plot_histogram(training$Count_Asphyxia)
```

The distribution of outcome data seems consistent with a count outcome approximated by theoretical distributions like the Poisson or negative binomial.

## Visualize raw predictors

```{r}
plot_histogram(select(training, 2:32))
```

We can anticipate that many of these variables will be highly correlated with each other. Let's look closer.

## Explore correlations

Here we'll generate a correlation matrix.

```{r}
corr <- training %>%
    as_tibble() %>%
    select(-FIPS, -geometry) %>%
    corrr::correlate()


corr
```

Note the numerous moderate to strongly-correlated variables. We will need to incorporate decorrelation into our pre-processing steps.

# Pre-processing

As alluded to earlier, we will be using Poisson regression as the primary model of consideration. According to Appendix A of @silgeTidyModeling, the recommended pre-processing steps for Poisson regression are dummy variable generation, removal of columns with single unique values, imputation for missing data, de-correlation, and possibly transformation.

Many of these steps are not necessary for our data set. Because we do not have categorical predictors, we do not need to perform dummy variable generation or removal of columns with single unique variables. Because we do not have any missing data, we do not need to perform imputation. That leaves transformation and de-correlation.


## Predictor selection

Intertwined with decorrelation, is the actual selection of predictor variables. Let's start with a manual process.

### Manual selection

Start by showing variables that have at least a weak correlation with asphyxiation count:

```{r}
corr %>%
    filter(abs(Count_Asphyxia) > 0.20) %>%
    arrange(desc(abs(Count_Asphyxia)))
```

The percent of people living in a census tract with public insurance (barely) has the strongest correlation with asphyxiation count.

Now show variables that at least have a weak correlation with asphyxiation count **AND** have less than a moderate correlation with public insurance.

```{r}
corr %>%
    filter(abs(Count_Asphyxia) > 0.20) %>%
    filter(abs(publicinsurance) < 0.5)
```

This just leaves the count of opioid deaths per census tract.

Using 2 predictors is an appropriately parsimonious model. That said, later we can also compare the relative predictive utility of adding one more variable -- the percentage of white people per census tract. 

Here is a final summary of correlation between the predictors selected and the outcome.

```{r}
corr %>%
    focus(
        Count_Asphyxia, publicinsurance, Count_OPIOID_Death, white,
        mirror = TRUE
    )
```

And here are summary statistics of those predictors.

```{r}
training %>%
    select(Count_OPIOID_Death, publicinsurance, white) %>%
    summary()

```
With these predictors selected, let's set up our base pre-processing recipe.

```{r}
base_recipe <- 
    recipe(
        Count_Asphyxia ~ Count_OPIOID_Death + publicinsurance,
        data = training
    )
```

## Transformation

### Centering

For ease of intercept interpretation, we will center the `publicinsurance` variable, since its minimum value never reaches zero.

```{r}
base_recipe <- 
    base_recipe %>%
    step_center(publicinsurance)
```

# Model Development

## Develop multivariate Poisson regression model

```{r}
pub_pois <-
    glm(
        Count_Asphyxia ~ publicinsurance,
        family = poisson(),
        data = training
    )

summary(pub_pois)
```
```{r}
pub_opi_pois <-
    glm(
        Count_Asphyxia ~ publicinsurance + Count_OPIOID_Death,
        family = poisson(),
        data = training
    )

summary(pub_opi_pois)
```
```{r}
pub_opi_whi_pois <-
    glm(
        Count_Asphyxia ~ publicinsurance + Count_OPIOID_Death + white,
        family = poisson(),
        data = training
    )

summary(pub_opi_whi_pois)
```
```{r}
anova(pub_pois, pub_opi_pois, pub_opi_whi_pois, test = "Chisq")
```


### Fitted model equation

$log(Count\_Asphyxia) = 0.0252(Count\_OPIOID\_Death) + 0.0462(centered\_public\_insurance) - 1.816$
    
### Interpreting coefficients
    
The constant term is the prediction if `Count_OPIOID_Death` = 0 and `centered_public_insurance` = 0. In this case, because weâ€™ve centered `public_insurance`, it implies that $e^{-1.816} = 0.163$, is the predicted number of asphyxiation deaths in a census tract with no opioid-related deaths and with the mean percentage of residents holding public insurance.

The coefficient of `Count_OPIOID_Death`, 0.025, is the expected increase in count of asphyxiation deaths (on the log scale) for each additional opioid-related death. The expected multiplicative increase is $e^0.025 = 1.026$, corresponding to a 2.6% increase in the count.

The coefficient of `centered_public_insurance`, 0.0462, is the expected increase in count of asphyxiation deaths (on the log scale) for each additional percentage point of residents on public insurance. The expected multiplicative increase is $e^0.0462 = 1.047$, corresponding to a 4.7% increase in the count.

Each coefficient is interpreted as a comparison where one predictor changes by one unit, while the others remain constant.




