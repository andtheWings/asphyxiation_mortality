---
title: "Infant Asphyxiation Mortality Modeling"
author: "Daniel P. Riggins, MD"
date: "11/1/2021"
output: html_document
---

This modeling analysis will seek to predict infant asphyxiation deaths in Chicagoland census tracts using a variety of census-level predictor variables, many of which are derived from the CDC's [Social Vulnerability Index (SVI)](https://seandavi.github.io/sars2pack/reference/cdc_social_vulnerability_index.html).

# Set Up

## Load needed libraries:

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(DataExplorer)
library(corrr)
library(vcd)
library(tidycensus)
library(sf)
tidymodels_prefer()
```

## Set pseudo-random seed for reproducibility:

```{r}
set.seed(324)
```

## Import the data:

```{r}
raw <- readxl::read_xlsx("data/finaldataforanalysis3_110221.xlsx")

glimpse(raw)
```

# Get census tract populations and spatial features

```{r}
enriched <-
    get_acs(
        geography = "tract",
        variables = "B01003_001",
        state = "IL",
        geometry = TRUE
    ) %>%
    filter(GEOID %in% raw$FIPS) %>%
    mutate(FIPS = as.numeric(GEOID)) %>%
    select(
        FIPS,
        population = estimate
    ) %>%
    full_join(raw)

glimpse(enriched)
```

# First Pass Exploration

## Split data into training and test sets:

```{r}
split <- initial_split(enriched, prop = 0.75)
training <- training(split)
testing <- testing(split)
```


## Summarize the primary outcome

```{r}
table(training$Count_Asphyxia)
```
## Visualize the primary outcome:

```{r}
plot_histogram(training$Count_Asphyxia)
```

The distribution of outcome data seems consistent with a count outcome approximated by theoretical distributions like the Poisson or negative binomial.

## Visualize raw predictors

```{r}
plot_histogram(select(training, 2:32))
```

We can anticipate that many of these variables will be highly correlated with each other. Let's look closer.

## Explore correlations

Here we'll generate a correlation matrix.

```{r}
corr <- training %>%
    select(-FIPS) %>%
    correlate() 


corr
```

Note the numerous moderate to strongly-correlated variables. We will need to incorporate decorrelation into our pre-processing steps.

# Pre-processing

As alluded to earlier, we will be using Poisson regression as the primary model of consideration. According to Appendix A of @silgeTidyModeling, the recommended pre-processing steps for Poisson regression are dummy variable generation, removal of columns with single unique values, imputation for missing data, de-correlation, and possibly transformation.

Many of these steps are not necessary for our data set. Because we do not have categorical predictors, we do not need to perform dummy variable generation or removal of columns with single unique variables. Because we do not have any missing data, we do not need to perform imputation. That leaves transformation and de-correlation.


## Predictor selection

Intertwined with decorrelation, is the actual selection of predictor variables. Let's start with a manual process.

### Manual selection

Start by showing variables that have at least a weak correlation with asphyxiation count:

```{r}
corr %>%
    filter(abs(Count_Asphyxia) > 0.25) %>%
    arrange(desc(abs(Count_Asphyxia)))
```

The percent of people living in a census tract with public insurance (barely) has the strongest correlation with asphyxiation count.

Now show variables that at least have a weak correlation with asphyxiation count **AND** have less than a moderate correlation with public insurance.

```{r}
corr %>%
    filter(abs(Count_Asphyxia) > 0.25) %>%
    filter(abs(publicinsurance) < 0.5)
```
    )

summary(tbl$count_Asphyxia_cat)
```

```{r}
plot_intro(tbl)
```


