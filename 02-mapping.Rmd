# (PART) Exploratory Analysis {-}

# Mapping SIDS Deaths

```{r echo=FALSE}
# # Work around to getting map into a Knitted document per https://github.com/arc2r/book/issues/31
# htmlwidgets::saveWidget(m, file = "media/cook_county_sids_deaths.html")
# 
# # Move to website directory
# file.copy(
#     from = "media/cook_county_sids_deaths.html", 
#     to = "/home/riggins/andtheWings.github.io/widgets/cook_county_sids_deaths.html"
# )

knitr::include_url("http://danielriggins.com/widgets/cook_county_sids_deaths.html")
```

*Visit [http://danielriggins.com/widgets/cook_county_sids_deaths.html](http://danielriggins.com/widgets/cook_county_sids_deaths.html) for a full-screen view.*



```{r}
tar_make()
tar_load(sids)
tar_load(sids_pop_est_and_polygons)
```


### Reshape data for use in the map

```{r}
library(targets)
library(dplyr)
library(sf)
tar_make()
sids <- 
    tar_read(sids) |> 
    select(
        fips, 
        pop_under_five, public_insurance, count_opioid_death, white
    )

resids_from_nb_model_of_sids <-
    tar_read(nb_model_of_sids) |> 
    broom::augment(
        type.residuals = "pearson"
    ) |> 
    select(
        pop_under_five, public_insurance, count_opioid_death, white, 
        .resid, .std.resid
    )

polygons <-
    tar_read(sids_pop_est_and_polygons) |> 
    select(-pop_total, -pop_under_five)

resids_map_data <-
    full_join(
        polygons, sids,
        by = c("fips")
    ) |> 
    inner_join(
        resids_from_nb_model_of_sids,
        by = c("pop_under_five", "public_insurance", "count_opioid_death", "white")
    ) |> 
    st_as_sf() |> 
    st_transform(crs = "WGS84")
```


```{r}
library(leaflet)
library(leaflet.extras)
m <- leaflet(resids_map_data) |>
    # Use CartoDB's background tiles
    addProviderTiles("CartoDB.Positron") |>
    # Center and zoom the map to Cook County
    setView(lat = 41.816544, lng = -87.749500, zoom = 9) |>
    # Add button to enable fullscreen map
    addFullscreenControl() |>
    # Add census tract polygons colored to reflect the number of deaths
    addPolygons(
        # No borders to the polygons, just fill
        stroke = TRUE,
        # Color according to palette above
        color = ~ .std.resid,
        # Make slightly transparent
        fillOpacity = 0.5,
        # Click on the polygon to get its ID
        popup = ~ paste0("<b>FIPS ID:</b> ", as.character(fips))
    ) 

m
```
